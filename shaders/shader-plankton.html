<polymer-element name="shader-plankton" extends="shader-template">
  <template>
    <script id="vertex" type="x-shader/x-vertex">
      precision mediump float;   
      ##ATTRIBUTES##
      ##UNIFORMS##
      ##VARYINGS##
      ##CHUNKS##

      void main(void) { 

        // TODO BUG fix it
        float a = aVertexPosition.x + aVertexNormal.x + aVertexColor.x + aSkinWeight.x + aTextureCoord.x;
          
        float rotationSpeed = uTime*sin(uPID);
        mat4 rotation = mat4(
              vec4( cos(rotationSpeed),  sin(rotationSpeed),  0.0,  0.0),
              vec4(-sin(rotationSpeed),  cos(rotationSpeed),  0.0,  0.0),
              vec4(0.0,   0.0,  1.0,  0.0),
              vec4(0.0,   0.0,  0.0,  1.0)
        );  
        
        vec3 pos = vec3(uWorld * rotation * vec4(aVertexPosition, 1.0)) * uScale + uPosition;
        
        //matrices
        vWorld = uWorld * vec4(pos, 1.0);
        vec4 worldViewProj = uWorldViewProj * vec4(pos, 1.0);
        
        float lightFalloff = pow(max(1.0-(distance(uLightPos, vWorld.xyz)/uLightRadius), 0.0),2.0);
        vDiffuse = uLightCol.rgb * vec3(lightFalloff * uLightCol.a);

        vFade = min(1.0,uBbox[0]-abs(uPosition[0]));
        vFade *= min(1.0,uBbox[1]-abs(uPosition[1]));
        vFade *= min(1.0,uBbox[2]-abs(uPosition[2]));

        vTextureCoord = aTextureCoord;
        gl_Position = worldViewProj;    
      }
    </script>
    <script id="fragment" type="x-shader/x-fragment">
      precision mediump float;
      ##UNIFORMS##
      ##VARYINGS##
      void main(void) {

        vec3 caustics = texture2D(uSampler1, vec2((vWorld.x)/48.+uTime/12., (vWorld.z-vWorld.y)/95.)).rgb;
        vec4 colorMap = texture2D(uSampler0, vec2((vTextureCoord.s+uPID)*.25, (vTextureCoord.t+floor(uPID*.25))*.25));
        float transparency = colorMap.r * caustics.r * vFade; 

        vec3 ambient = uAmbientCol.rgb * uAmbientCol.a;

        vec4 composit = vec4((vDiffuse + caustics + ambient)*colorMap.rgb,transparency);
        
        if (uShaderDebug == 1.0) {composit = vec4(vDiffuse,1.0);}//diffuse
        else if (uShaderDebug == 4.0) {composit = vec4(ambient,1.0);}//ambient
        else if (uShaderDebug == 5.0) {composit = vec4(caustics.rgb,1.0);}//caustics
        else if (uShaderDebug == 6.0) {composit = vec4(colorMap.rgb,1.0);}//color
        else if (uShaderDebug == 7.0) {composit = vec4(vec3(transparency),1.0);}//transparency

        gl_FragColor = composit;

      }
    </script>
  </template>
  <script>
    Polymer('shader-plankton');
  </script>
</polymer-element>